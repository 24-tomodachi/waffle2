<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GameBoy like Canvas</title>
  <link rel="stylesheet" href="/stylesheets/canvas.css">
</head>
<body>
  <main>
    <canvas id="display" width="400" height="300"></canvas>
    <div class="buttons">
      <div class="buttons__move">
        <button id="up">â†‘</button>
        <button id="left">â†</button>
        <button id="right">â†’</button>
        <button id="down">â†“</button>
      </div>
    </div>
    <div class="sidebar hidden">
      <button id="profile">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</button>
      <button id="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <div class="sidebar-toggle" id="toggle-sidebar">â–¶</div>
    <div class="reaction-selector">
      <button id="toggle-reactions">â–¼</button>
      <div class="reactions hidden">
        <button class="reaction" data-reaction="ğŸ˜Š">ğŸ˜Š</button>
        <button class="reaction" data-reaction="ğŸ˜¢">ğŸ˜¢</button>
        <button class="reaction" data-reaction="ğŸ˜ ">ğŸ˜ </button>
        <button class="reaction" data-reaction="ğŸ˜‚">ğŸ˜‚</button>
        <button class="reaction" data-reaction="ğŸ˜">ğŸ˜</button>
        <button class="reaction" data-reaction="ğŸ˜">ğŸ˜</button>
      </div>
    </div>
  </main>
  <script>
    // HTMLè¦ç´ ã‚’å–å¾—
    const canvas = document.getElementById('display');
    const ctx = canvas.getContext('2d');

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å®šç¾©
    const character = {
        x: 10,
        y: 2,
        width: 16, // ç”»åƒã®å¹…
        height: 16, // ç”»åƒã®é«˜ã•
        speed: 1,
        isSitting: false, // åº§ã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
        sittingX: 0, // åº§ã£ã¦ã„ãŸä½ç½®ã®Xåº§æ¨™
        sittingY: 0, // åº§ã£ã¦ã„ãŸä½ç½®ã®Yåº§æ¨™
        image: new Image(), // Imageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        draw: function () {
            ctx.drawImage(this.image, this.x, this.y, this.width, this.height); // ç”»åƒã‚’æç”»
        }
    };

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç”»åƒã®ãƒ‘ã‚¹
    character.image.src = '/image/icon.png'; // ç”»åƒã®ãƒ‘ã‚¹ã‚’æŒ‡å®š

    // æœºã¨æ¤…å­ã®ç”»åƒã®èª­ã¿è¾¼ã¿
    const deskImage = new Image();
    deskImage.src = '/image/tukue.jpg';

    const chairImage = new Image();
    chairImage.src = '/image/æ¤…å­ã€€ä¸‹å‘ã.png';

    const chairueImage = new Image();
    chairueImage.src = '/image/isu uemuki.png';

    const hunsuiImage = new Image();
    hunsuiImage.src = '/image/hunsui3.png';

    const kiImage = new Image();
    kiImage.src = '/image/ki2.png';

    // éšœå®³ç‰©ã®å®šç¾©
    let obstacles = [];

    // JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
    const obstaclesDataPath = '/config/obstacles.json';

    // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰éšœå®³ç‰©ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
    async function loadObstacles() {
        try {
            const response = await fetch(obstaclesDataPath);
            obstacles = await response.json();
            console.log('Obstacles loaded:', obstacles);
        } catch (error) {
            console.error('Error loading obstacles:', error);
        }
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨éšœå®³ç‰©ãŒè¡çªã—ã¦ã„ã‚‹ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
    function isColliding(rect1, rect2) {
        return rect1.x < rect2.x + rect2.width &&
               rect1.x + rect1.width > rect2.x &&
               rect1.y < rect2.y + rect2.height &&
               rect1.y + rect1.height > rect2.y;
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒæŒ‡å®šã•ã‚ŒãŸåº§æ¨™ã«ç§»å‹•ã§ãã‚‹ã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
    function canMoveTo(x, y) {
        for (let obstacle of obstacles) {
            if (isColliding({ x, y, width: character.width, height: character.height }, obstacle)) {
                return false; // ç§»å‹•ã§ããªã„
            }
        }
        return true; // ç§»å‹•ã§ãã‚‹
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç§»å‹•ã™ã‚‹é–¢æ•°
    function moveCharacter(dx, dy) {
        const newX = character.x + dx;
        const newY = character.y + dy;

        // ç”»é¢ã®ç«¯ã«æ¥ãŸã‚‰æ­¢ã¾ã‚‹
        if (newX < 0) {
            character.x = 0;
        } else if (newX + character.width > canvas.width) {
            character.x = canvas.width - character.width;
        } else if (newY < 0) {
            character.y = 0;
        } else if (newY + character.height > canvas.height) {
            character.y = canvas.height - character.height;
        } else {
            if (canMoveTo(newX, newY)) {
                character.x = newX;
                character.y = newY;
            }
        }
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®å…¥åŠ›ã«å¿œã˜ã¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç§»å‹•ã•ã›ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('keydown', function (e) {
        switch (e.key) {
            case 'ArrowUp':
            case 'w':
            case 'W':
                moveCharacter(0, -character.speed);
                break;
            case 'ArrowDown':
            case 's':
            case 'S':
                moveCharacter(0, character.speed);
                break;
            case 'ArrowLeft':
            case 'a':
            case 'A':
                moveCharacter(-character.speed, 0);
                break;
            case 'ArrowRight':
            case 'd':
            case 'D':
                moveCharacter(character.speed, 0);
                break;
            case ' ':
                if (character.isSitting) {
                    // æ¤…å­ã«åº§ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã‚‰ã€åº§ã£ã¦ã„ãŸä½ç½®ã«æˆ»ã‚‹
                    character.isSitting = false;
                    character.x = character.sittingX;
                    character.y = character.sittingY;
                } else {
                    // æ¤…å­ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†
                    checkForChairCollision();
                }
                break;
        }
    });

    // æ¤…å­ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†é–¢æ•°
    function checkForChairCollision() {
        const chairObstacles = obstacles.filter(obstacle => obstacle.name.includes("æ¤…å­") || obstacle.name.includes("ä¸Š"));
        const characterX = character.x + character.width / 2;
        const characterY = character.y + character.height / 2;
        const chairsData = chairObstacles.map(obstacle => {
            const centerX = obstacle.x + obstacle.width / 2;
            const centerY = obstacle.y + obstacle.height / 2;
            const radius = 30; // åŠå¾„30ã®å††å½¢é ˜åŸŸã‚’è¨­å®š
            return { centerX, centerY, radius };
        });

        let nearestChairIndex = -1;
        let minDistance = Number.MAX_SAFE_INTEGER;
        for (let i = 0; i < chairsData.length; i++) {
            const distanceToChair = Math.sqrt(Math.pow(characterX - chairsData[i].centerX, 2) + Math.pow(characterY - chairsData[i].centerY, 2));
            if (distanceToChair <= chairsData[i].radius && distanceToChair < minDistance) {
                minDistance = distanceToChair;
                nearestChairIndex = i;
            }
        }

        if (nearestChairIndex !== -1) {
            const nearestChair = chairObstacles[nearestChairIndex];
            character.sittingX = character.x;
            character.sittingY = character.y;
            character.x = nearestChair.x;
            character.y = nearestChair.y;
            character.isSitting = true;
        }
    }

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®HTMLè¦ç´ 
    const reactionSelector = document.querySelector('.reaction-selector');
    const toggleReactionsButton = document.getElementById('toggle-reactions');
    const reactionsDiv = document.querySelector('.reactions');

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    toggleReactionsButton.addEventListener('click', () => {
        reactionsDiv.classList.toggle('hidden');
    });

    // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚’å‡¦ç†
    document.querySelectorAll('.reaction').forEach(button => {
        button.addEventListener('click', (event) => {
            const reaction = event.target.getAttribute('data-reaction');
            showReaction(reaction);
            reactionsDiv.classList.add('hidden'); // ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠå¾Œã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        });
    });

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ä¸Šã«ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showReaction(reaction) {
        const reactionElement = document.createElement('div');
        reactionElement.textContent = reaction;
        reactionElement.classList.add('reaction-display');

        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä½ç½®ã‚’å–å¾—
        const canvasRect = canvas.getBoundingClientRect();
        reactionElement.style.left = `${character.x * 3.2}px`;
        reactionElement.style.top = `${character.y * 1.9}px`; // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®çœŸä¸Šã«è¡¨ç¤º

        document.body.appendChild(reactionElement);

        setTimeout(() => {
            reactionElement.remove();
        }, 2400); // 2.4ç§’å¾Œã«å‰Šé™¤
    }

    const sidebar = document.querySelector('.sidebar');
    const toggleSidebarButton = document.getElementById('toggle-sidebar');

    toggleSidebarButton.addEventListener('click', () => {
        sidebar.classList.toggle('active'); // activeã‚¯ãƒ©ã‚¹ã‚’ãƒˆã‚°ãƒ«ã—ã¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’è¡¨ç¤º/éè¡¨ç¤ºã«ã™ã‚‹
        toggleSidebarButton.classList.toggle('active'); // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚‚å¤‰æ›´ã™ã‚‹
    });

    // ã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—å†…ã§å¹ãå‡ºã—é¢¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æç”»
    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height); // ç”»é¢ã‚’ã‚¯ãƒªã‚¢

        // éšœå®³ç‰©ã®æç”»
        for (let obstacle of obstacles) {
            if (obstacle.name.includes("æœº")) {
                ctx.drawImage(deskImage, obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            } else if (obstacle.name.includes("æ¤…å­")) {
                ctx.drawImage(chairImage, obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            } else if (obstacle.name.includes("ä¸Š")) {
                ctx.drawImage(chairueImage, obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            } else if (obstacle.name.includes("å™´æ°´")) {
                ctx.drawImage(hunsuiImage, obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            } else if (obstacle.name.includes("æœ¨")) {
                ctx.drawImage(kiImage, obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            } else {
                ctx.fillStyle = 'brown';
                ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            }
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æç”»
        character.draw();

        // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã®æç”»ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        requestAnimationFrame(update);
    }

    // ã‚²ãƒ¼ãƒ ã®ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
    function startGame() {
        loadObstacles().then(() => {
            update(); // æœ€åˆã®ç”»é¢æ›´æ–°
        });
    }

    startGame(); // ã‚²ãƒ¼ãƒ ã®é–‹å§‹

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    document.getElementById('logout').addEventListener('click', () => {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
            alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’ã“ã“ã«è¿½åŠ ã™ã‚‹
            //ãƒ›ãƒ¼ãƒ ç”»é¢ã«é£›ã¶
        }
    });
  </script>
</body>
</html>
